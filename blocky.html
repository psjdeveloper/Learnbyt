<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>LearnByte Flash — Solidity Parser</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #f8fafc;
      color: #0f172a;
    }
    .wrap { max-width: 1100px; margin: 24px auto; padding: 16px; }
    .card {
      background: #fff;
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 1px 6px rgba(0,0,0,.08);
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 12px;
    }
    .btn {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: #fff;
      cursor: pointer;
    }
    .btn.primary {
      background: #0ea5e9;
      color: white;
      border: none;
    }
    pre {
      background: #0f172a;
      color: #fff;
      padding: 10px;
      border-radius: 8px;
      height: 180px;
      overflow: auto;
    }
    select {
      padding: 6px 8px;
      border-radius: 6px;
    }
    .small { font-size: 13px; color: #6b7280; }
  </style>

  <!-- Monaco Editor -->
  <script>
    window.require = { paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.38.0/min/vs' } };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.38.0/min/vs/loader.js"></script>

  <!-- Solidity Parser -->
  <script src="https://cdn.jsdelivr.net/npm/solidity-parser-antlr@0.4.11/dist/index.min.js"></script>
</head>

<body>
<div class="wrap">
  <h2>Blockly by LearnByte</h2>
  <p class="small">Solidity learning using AST (no compiler)</p>

  <div class="grid">
    <div class="card">
      <strong id="title">Hello Flash</strong>
      <p id="prompt" class="small">Create a function hi() that returns "Hello Flash"</p>

      <select id="challengeSelect"></select>

      <div id="editor" style="height:420px;border:1px solid #e5e7eb;border-radius:8px;"></div>

      <div style="margin-top:10px;display:flex;gap:8px;">
        <button class="btn primary" id="runBtn">Validate</button>
        <button class="btn" id="resetBtn">Reset</button>
        <span class="small">Streak: <b id="streak">0</b></span>
      </div>
    </div>

    <div class="card">
      <strong>Console</strong>
      <pre id="console">Ready.</pre>
    </div>
  </div>
</div>

<script>
/* ------------------ Challenges ------------------ */
const challenges = [
  {
    title: "Hello Flash",
    prompt: "Create a function hi() that returns a string",
    starter: `pragma solidity ^0.8.0;

contract Hello {
  function hi() public pure returns (string memory) {
    return "Hello Flash";
  }
}`,
    check(ast) {
      let found = false;
      solidityParser.visit(ast, {
        FunctionDefinition(node) {
          if (node.name === "hi") found = true;
        }
      });
      return found ? null : "Function hi() not found";
    }
  },
  {
    title: "Add Two Numbers",
    prompt: "Create add(uint a, uint b) that returns uint",
    starter: `pragma solidity ^0.8.0;

contract Add {
  function add(uint a, uint b) public pure returns (uint) {
    return a + b;
  }
}`,
    check(ast) {
      let ok = false;
      solidityParser.visit(ast, {
        FunctionDefinition(node) {
          if (node.name === "add" && node.parameters.length === 2) {
            ok = true;
          }
        }
      });
      return ok ? null : "Function add(a,b) not detected";
    }
  }
];

/* ------------------ State ------------------ */
let editor;
let streak = Number(localStorage.getItem("streak") || 0);

/* ------------------ Helpers ------------------ */
const $ = id => document.getElementById(id);
const log = msg => $("console").textContent = msg;

/* ------------------ Monaco Init ------------------ */
require(["vs/editor/editor.main"], () => {
  editor = monaco.editor.create($("editor"), {
    value: challenges[0].starter,
    language: "solidity",
    theme: "vs-light",
    minimap: { enabled: false },
    automaticLayout: true
  });
});

/* ------------------ UI Setup ------------------ */
challenges.forEach((c,i)=>{
  const o = document.createElement("option");
  o.value = i;
  o.textContent = c.title;
  $("challengeSelect").appendChild(o);
});

$("streak").textContent = streak;

/* ------------------ Events ------------------ */
$("challengeSelect").onchange = e => {
  const c = challenges[e.target.value];
  $("title").textContent = c.title;
  $("prompt").textContent = c.prompt;
  editor.setValue(c.starter);
};

$("resetBtn").onclick = () => {
  const i = $("challengeSelect").value;
  editor.setValue(challenges[i].starter);
};

$("runBtn").onclick = () => {
  const src = editor.getValue();
  let ast;

  try {
    ast = solidityParser.parse(src, { tolerant: false });
  } catch (e) {
    log("❌ Syntax Error:\n" + e.message);
    return;
  }

  const challenge = challenges[$("challengeSelect").value];
  const error = challenge.check(ast);

  if (error) {
    log("❌ " + error);
  } else {
    streak++;
    localStorage.setItem("streak", streak);
    $("streak").textContent = streak;
    log("✅ Passed! AST validation successful.");
  }
};
</script>
</body>
</html>
